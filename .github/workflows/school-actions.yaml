name: Django DRF with Apache Solr and PostgreSQL CI
'on':
  push:
    branches:
      - feat/github-workflow-setup
  pull_request:
    branches:
      - main
jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: 'postgres:14'
        env:
          POSTGRES_DB: test_electo_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - '5432:5432'
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s
          --health-timeout 5s --health-retries 5
      solr:
        image: 'solr:8.9.0'
        ports:
          - '8983:8983'
        options: '--name ct-solr -e SOLR_HEAP=512m'
        env:
          SOLR_JAVA_MEM: '-Xms512m -Xmx512m'
    steps:
      - name: Print settings module
        env:
          STATE: "Gujarat"
          STATE2: MP
          BRO: ${{ vars.PROJECT_OWNER }}
        run: |
          echo "DJANGO_SETTINGS_MODULE is set to: ${{ vars.DJANGO_SETTINGS_MODULE }}"
          echo "Project owner is set to: ${{ vars.PROJECT_OWNER }}"
          echo "Project City is set to: ${{ secrets.CITY }}"
          echo "The secret Country is: ${{ secrets.COUNTRY }}"
          echo "Step env Guj state: ${STATE}"
          echo "Step env MP state2: ${STATE2}"
          echo "i AM bRO lower: ${bro}"
          echo "i AM bRO UPPER: ${BRO}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Set up Apache Solr
        run: |
          docker exec ct-solr solr create -c electo_core -d sample_techproducts_configs
          echo "Solr core 'electo_core' created"    

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up the Django project
        run: |
          python manage.py migrate

      - name: Run tests
        run: |
          python manage.py test
